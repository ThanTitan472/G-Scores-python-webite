{% extends 'base.html' %}

{% block content %}
<form action="{% url 'reports' %}" method="post">
    {% csrf_token %}
    <select name="sub" onchange="this.form.submit()">
        <option value="toan" {% if selected_sub == "toan" %}selected{% endif %}>Toán</option>
        <option value="ngu_van" {% if selected_sub == "ngu_van" %}selected{% endif %}>Ngữ văn</option>
        <option value="ngoai_ngu" {% if selected_sub == "ngoai_ngu" %}selected{% endif %}>Ngoại ngữ</option>
        <option value="vat_li" {% if selected_sub == "vat_li" %}selected{% endif %}>Vật lý</option>
        <option value="hoa_hoc" {% if selected_sub == "hoa_hoc" %}selected{% endif %}>Hóa học</option>
        <option value="sinh_hoc" {% if selected_sub == "sinh_hoc" %}selected{% endif %}>Sinh học</option>
        <option value="lich_su" {% if selected_sub == "lich_su" %}selected{% endif %}>Lịch sử</option>
        <option value="dia_li" {% if selected_sub == "dia_li" %}selected{% endif %}>Địa lý</option>
        <option value="gdcd" {% if selected_sub == "gdcd" %}selected{% endif %}>GDCD</option>
    </select>
</form>
<br>
<br>

<h3>Biểu đồ phổ điểm môn {{ sub }}</h3>

<div class="chart-container">
    <canvas id="scoreChart"></canvas>
</div>

{{ label|json_script:"label" }}
{{ data|json_script:"data" }}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const rawLabels = JSON.parse(document.getElementById("label").textContent);
    const rawData = JSON.parse(document.getElementById("data").textContent);

    let labels = Array.isArray(rawLabels) ? rawLabels : [];
    let data = Array.isArray(rawData) ? rawData : [];

    if (typeof rawLabels === 'string') {
        try { labels = JSON.parse(rawLabels); } catch(e) {}
    }
    if (typeof rawData === 'string') {
        try { data = JSON.parse(rawData); } catch(e) {}
    }

    const ctx = document.getElementById("scoreChart").getContext("2d");
    
    new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Số lượng học sinh",
                data: data,
                backgroundColor: "rgba(78,115,223,0.85)",
                categoryPercentage: 0.9,
                barPercentage: 0.9, 
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: "Phổ điểm"
                    },
                    ticks: {
                        font: { size: 11 },
                        autoSkip: true, 
                        maxTicksLimit: 20,
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: "Số lượng học sinh"
                    },
                    ticks: {
                         stepSize: 1,
                         precision: 0
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            }
        }
    });
});
</script>
{% endblock %}
